<!--
================================================================================
STRING ART 2026 - SHOPIFY EMBED VERSION
================================================================================
Este c√≥digo es autocontenido y puede insertarse directamente en una p√°gina de Shopify.
Incluye: Landing Page + Generador de String Art completo.

INSTRUCCIONES PARA SHOPIFY:
1. Ve a tu Admin de Shopify ‚Üí Online Store ‚Üí Pages
2. Crea una nueva p√°gina o edita una existente
3. Haz clic en "<>" para ver el c√≥digo HTML
4. Pega todo este c√≥digo
5. Guarda la p√°gina

O para crear una secci√≥n custom:
1. Ve a Online Store ‚Üí Themes ‚Üí Actions ‚Üí Edit code
2. En la carpeta "Sections", crea un nuevo archivo: string-art.liquid
3. Pega este c√≥digo
4. Usa la secci√≥n en tu p√°gina con el Theme Editor
================================================================================
-->

<style>
/* ===== STRING ART 2026 - EMBEDDED STYLES ===== */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

.string-art-app {
  --stone-50: #fafaf9;
  --stone-100: #f5f5f4;
  --stone-200: #e7e5e4;
  --stone-300: #d6d3d1;
  --stone-400: #a8a29e;
  --stone-500: #78716c;
  --stone-600: #57534e;
  --stone-700: #44403c;
  --stone-800: #292524;
  --stone-900: #1c1917;
  --rose-100: #ffe4e6;
  --rose-200: #fecdd3;
  --rose-500: #f43f5e;
  --rose-600: #e11d48;
  --white: #ffffff;
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  --shadow-rose: 0 10px 30px -10px rgba(244, 63, 94, 0.3);
  
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--stone-900);
  background: var(--stone-50);
  min-height: 100vh;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.string-art-app *, .string-art-app *::before, .string-art-app *::after {
  box-sizing: border-box;
}

.string-art-app ::selection {
  background: var(--rose-200);
  color: var(--stone-900);
}

/* Container */
.sa-container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 1rem;
}

@media (min-width: 640px) {
  .sa-container { padding: 0 1.5rem; }
}

/* Navbar */
.sa-navbar {
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(250, 250, 249, 0.8);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--stone-200);
  padding: 1rem 0;
}

.sa-navbar-inner {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sa-logo {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
}

.sa-logo-icon {
  width: 40px;
  height: 40px;
  background: var(--stone-900);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--white);
  font-weight: 900;
  font-size: 1.25rem;
}

.sa-logo-text {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--stone-900);
}

.sa-logo-text span {
  color: var(--rose-500);
}

.sa-nav-links {
  display: none;
  gap: 1.5rem;
}

@media (min-width: 768px) {
  .sa-nav-links { display: flex; }
}

.sa-nav-links a {
  color: var(--stone-500);
  text-decoration: none;
  font-weight: 500;
  transition: color 0.2s;
}

.sa-nav-links a:hover {
  color: var(--stone-900);
}

/* Buttons */
.sa-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  font-weight: 600;
  border-radius: 12px;
  padding: 0.75rem 1.5rem;
  cursor: pointer;
  transition: all 0.3s;
  border: none;
  text-decoration: none;
  font-size: 1rem;
}

.sa-btn-primary {
  background: var(--stone-900);
  color: var(--white);
  box-shadow: var(--shadow-lg);
}

.sa-btn-primary:hover {
  background: var(--stone-800);
  box-shadow: var(--shadow-xl);
  transform: translateY(-2px);
}

.sa-btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.sa-btn-accent {
  background: linear-gradient(135deg, var(--rose-500), var(--rose-600));
  color: var(--white);
  box-shadow: var(--shadow-lg);
}

.sa-btn-accent:hover {
  box-shadow: var(--shadow-rose);
  transform: translateY(-2px);
}

.sa-btn-outline {
  background: transparent;
  color: var(--stone-700);
  border: 2px solid var(--stone-200);
}

.sa-btn-outline:hover {
  background: var(--stone-100);
  border-color: var(--stone-300);
}

.sa-btn-ghost {
  background: transparent;
  color: var(--stone-600);
  padding: 0.5rem;
}

.sa-btn-ghost:hover {
  background: var(--stone-100);
}

.sa-btn-lg {
  padding: 1rem 2rem;
  font-size: 1.125rem;
}

.sa-btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 10px;
}

/* Hero Section */
.sa-hero {
  padding: 4rem 0;
}

@media (min-width: 1024px) {
  .sa-hero { padding: 6rem 0; }
}

.sa-hero-grid {
  display: grid;
  gap: 3rem;
  align-items: center;
}

@media (min-width: 1024px) {
  .sa-hero-grid {
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
  }
}

.sa-hero-content {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.sa-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.375rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 700;
  width: fit-content;
}

.sa-badge-rose {
  background: var(--rose-100);
  color: var(--rose-600);
}

.sa-badge-stone {
  background: var(--stone-200);
  color: var(--stone-600);
}

.sa-hero-title {
  font-size: 2.5rem;
  font-weight: 900;
  line-height: 1.1;
  margin: 0;
}

@media (min-width: 640px) {
  .sa-hero-title { font-size: 3rem; }
}

@media (min-width: 1024px) {
  .sa-hero-title { font-size: 4rem; }
}

.sa-text-gradient {
  background: linear-gradient(135deg, var(--rose-500), var(--rose-600));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.sa-hero-desc {
  font-size: 1.125rem;
  color: var(--stone-500);
  line-height: 1.7;
  margin: 0;
  max-width: 500px;
}

.sa-hero-buttons {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

@media (min-width: 640px) {
  .sa-hero-buttons { flex-direction: row; }
}

/* Comparison Slider */
.sa-comparison {
  position: relative;
  background: var(--white);
  padding: 0.5rem;
  border-radius: 1.5rem;
  box-shadow: var(--shadow-xl);
}

.sa-comparison-inner {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  border-radius: 1rem;
  overflow: hidden;
  cursor: ew-resize;
}

.sa-comparison-img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.sa-comparison-overlay {
  position: absolute;
  inset: 0;
  background: var(--white);
}

.sa-comparison-result {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: grayscale(100%) contrast(150%) brightness(110%);
  mix-blend-mode: multiply;
}

.sa-comparison-texture {
  position: absolute;
  inset: 0;
  opacity: 0.6;
  pointer-events: none;
  background-image: 
    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.1) 3px),
    repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.1) 3px),
    repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.1) 3px),
    repeating-linear-gradient(135deg, transparent, transparent 2px, rgba(0,0,0,0.1) 3px);
  background-size: 4px 4px;
}

.sa-comparison-mask {
  position: absolute;
  inset: 0;
  background: radial-gradient(circle, transparent 68%, white 69%);
}

.sa-comparison-label {
  position: absolute;
  top: 1rem;
  padding: 0.375rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 700;
  backdrop-filter: blur(8px);
  z-index: 10;
}

.sa-comparison-label-left {
  left: 1rem;
  background: rgba(0,0,0,0.5);
  color: var(--white);
}

.sa-comparison-label-right {
  right: 1rem;
  background: var(--rose-500);
  color: var(--white);
}

.sa-comparison-handle {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--white);
  cursor: ew-resize;
  z-index: 20;
  box-shadow: 0 0 15px rgba(0,0,0,0.5);
}

.sa-comparison-handle-btn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 40px;
  height: 40px;
  background: var(--white);
  border-radius: 50%;
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 3px;
}

.sa-comparison-handle-line {
  width: 2px;
  height: 12px;
  background: var(--stone-400);
  border-radius: 1px;
}

.sa-comparison-slider {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: ew-resize;
  z-index: 30;
}

.sa-comparison-hint {
  position: absolute;
  bottom: 1.5rem;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(8px);
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  border: 1px solid var(--stone-200);
  z-index: 20;
  pointer-events: none;
}

.sa-comparison-hint span {
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--stone-600);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Features Section */
.sa-features {
  padding: 5rem 0;
}

.sa-section-header {
  text-align: center;
  max-width: 600px;
  margin: 0 auto 4rem;
}

.sa-section-title {
  font-size: 2rem;
  font-weight: 700;
  margin: 0.5rem 0 1rem;
}

@media (min-width: 640px) {
  .sa-section-title { font-size: 2.25rem; }
}

.sa-section-desc {
  color: var(--stone-500);
  font-size: 1.125rem;
  margin: 0;
}

.sa-features-grid {
  display: grid;
  gap: 2rem;
}

@media (min-width: 768px) {
  .sa-features-grid { grid-template-columns: repeat(3, 1fr); }
}

.sa-feature-card {
  padding: 1.5rem;
  border-radius: 1rem;
  background: var(--stone-100);
  border: 1px solid var(--stone-200);
  transition: all 0.3s;
}

.sa-feature-card:hover {
  background: var(--white);
  border-color: rgba(244, 63, 94, 0.3);
  box-shadow: var(--shadow-lg);
  transform: translateY(-4px);
}

.sa-feature-icon {
  width: 56px;
  height: 56px;
  background: var(--white);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
  margin-bottom: 1rem;
  font-size: 1.5rem;
}

.sa-feature-title {
  font-size: 1.25rem;
  font-weight: 700;
  margin: 0 0 0.5rem;
}

.sa-feature-desc {
  color: var(--stone-500);
  margin: 0;
  line-height: 1.6;
}

/* CTA Section */
.sa-cta {
  padding: 5rem 0;
  background: var(--stone-900);
  color: var(--white);
  text-align: center;
}

.sa-cta-title {
  font-size: 2.5rem;
  font-weight: 900;
  margin: 0 0 1rem;
}

@media (min-width: 640px) {
  .sa-cta-title { font-size: 3rem; }
}

.sa-cta-desc {
  color: var(--stone-400);
  font-size: 1.125rem;
  max-width: 500px;
  margin: 0 auto 2rem;
}

/* Footer */
.sa-footer {
  padding: 3rem 0;
  background: var(--stone-950);
  color: var(--stone-500);
  text-align: center;
}

.sa-footer p {
  margin: 0;
  font-size: 0.875rem;
}

/* ===== APP VIEW STYLES ===== */
.sa-app {
  min-height: 100vh;
  display: none;
}

.sa-app.active {
  display: block;
}

.sa-landing {
  display: block;
}

.sa-landing.hidden {
  display: none;
}

.sa-app-header {
  background: var(--white);
  border-bottom: 1px solid var(--stone-200);
  padding: 1rem;
  position: sticky;
  top: 0;
  z-index: 10;
}

.sa-app-header-inner {
  max-width: 1280px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sa-app-header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.sa-app-divider {
  width: 1px;
  height: 24px;
  background: var(--stone-200);
}

.sa-app-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 700;
  font-size: 1.25rem;
}

.sa-app-title svg {
  color: var(--rose-500);
}

.sa-app-status {
  background: var(--stone-100);
  padding: 0.375rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--stone-500);
}

.sa-app-main {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem 1rem;
  display: grid;
  gap: 2rem;
}

@media (min-width: 1024px) {
  .sa-app-main {
    grid-template-columns: 1fr 2fr;
    padding: 2rem;
  }
}

/* Control Panel */
.sa-panel {
  background: var(--white);
  border-radius: 1rem;
  border: 1px solid var(--stone-200);
  padding: 1.5rem;
  height: fit-content;
}

.sa-panel-section {
  margin-bottom: 2rem;
}

.sa-panel-section:last-child {
  margin-bottom: 0;
}

.sa-panel-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--stone-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.75rem;
}

.sa-panel-divider {
  border: none;
  border-top: 1px solid var(--stone-200);
  margin: 1.5rem 0;
}

/* Upload Area */
.sa-upload {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  border: 2px dashed var(--stone-300);
  border-radius: 12px;
  background: var(--stone-50);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s;
}

.sa-upload:hover {
  border-color: var(--stone-400);
}

.sa-upload.dragover {
  border-color: var(--rose-500);
  background: rgba(244, 63, 94, 0.05);
}

.sa-upload-placeholder {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.sa-upload-placeholder svg {
  width: 32px;
  height: 32px;
  color: var(--stone-400);
}

.sa-upload-placeholder span {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--stone-500);
}

.sa-upload-input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.sa-upload canvas {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Sliders */
.sa-slider-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-top: 0.75rem;
}

.sa-slider-item {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.sa-slider-label {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--stone-500);
}

.sa-slider-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.sa-slider-header label {
  font-size: 0.875rem;
  font-weight: 500;
}

.sa-slider-header span {
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--rose-500);
}

.sa-slider {
  width: 100%;
  height: 8px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--stone-200);
  border-radius: 4px;
  outline: none;
}

.sa-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  background: var(--white);
  border: 2px solid var(--rose-500);
  border-radius: 50%;
  cursor: grab;
  box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
}

.sa-slider::-webkit-slider-thumb:active {
  cursor: grabbing;
}

/* Inputs */
.sa-input-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.sa-input-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.sa-input-item label {
  font-size: 0.875rem;
  font-weight: 500;
}

.sa-input {
  width: 100%;
  padding: 0.75rem 1rem;
  background: var(--stone-50);
  border: 1px solid var(--stone-200);
  border-radius: 12px;
  font-size: 0.875rem;
  outline: none;
  transition: all 0.2s;
}

.sa-input:focus {
  border-color: var(--rose-500);
  box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1);
}

/* Canvas Area */
.sa-canvas-area {
  background: var(--stone-100);
  border-radius: 1rem;
  border: 1px solid var(--stone-200);
  padding: 2rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 500px;
}

.sa-canvas-frame {
  background: var(--white);
  padding: 1rem;
  border-radius: 0.5rem;
  box-shadow: var(--shadow-xl);
  position: relative;
}

.sa-canvas-frame::before {
  content: '';
  position: absolute;
  inset: 1rem;
  border-radius: 50%;
  border: 1px solid var(--stone-200);
  pointer-events: none;
  opacity: 0.5;
}

.sa-canvas {
  width: 100%;
  max-width: 500px;
  aspect-ratio: 1;
  background: var(--white);
}

.sa-canvas-placeholder {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.8);
  color: var(--stone-400);
  font-weight: 500;
}

/* Progress */
.sa-progress {
  width: 100%;
  max-width: 400px;
  margin-top: 1.5rem;
}

.sa-progress-bar {
  width: 100%;
  height: 8px;
  background: var(--stone-200);
  border-radius: 4px;
  overflow: hidden;
}

.sa-progress-fill {
  height: 100%;
  background: var(--rose-500);
  border-radius: 4px;
  transition: width 0.3s ease;
}

/* Stats */
.sa-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 2rem;
  text-align: center;
  width: 100%;
  max-width: 400px;
  margin-top: 1.5rem;
}

.sa-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--stone-800);
}

.sa-stat-label {
  font-size: 0.75rem;
  color: var(--stone-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Actions */
.sa-actions {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  padding-top: 1rem;
}

.sa-actions .sa-btn {
  width: 100%;
}

/* History */
.sa-history {
  background: var(--white);
  border-radius: 1rem;
  border: 1px solid var(--stone-200);
  padding: 1rem;
  margin-top: 1.5rem;
}

.sa-history-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--stone-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.75rem;
}

.sa-history-items {
  display: flex;
  gap: 1rem;
  overflow-x: auto;
  padding-bottom: 0.5rem;
}

.sa-history-items::-webkit-scrollbar {
  display: none;
}

.sa-history-item {
  flex-shrink: 0;
  cursor: pointer;
  position: relative;
}

.sa-history-thumb {
  width: 80px;
  height: 80px;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid var(--stone-200);
  transition: border-color 0.2s;
}

.sa-history-item:hover .sa-history-thumb {
  border-color: var(--rose-500);
}

.sa-history-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.sa-history-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.4);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s;
}

.sa-history-item:hover .sa-history-overlay {
  opacity: 1;
}

.sa-history-overlay svg {
  color: var(--white);
  width: 24px;
  height: 24px;
}

.sa-history-meta {
  margin-top: 0.25rem;
  text-align: center;
  font-size: 10px;
  color: var(--stone-500);
}

/* Guide Modal */
.sa-modal {
  position: fixed;
  inset: 0;
  z-index: 100;
  background: rgba(28, 25, 23, 0.95);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.sa-modal.active {
  display: flex;
}

.sa-modal-content {
  background: var(--white);
  width: 100%;
  max-width: 900px;
  max-height: 90vh;
  border-radius: 1.5rem;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.sa-modal-header {
  background: var(--stone-100);
  border-bottom: 1px solid var(--stone-200);
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sa-modal-header-left {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.sa-modal-icon {
  width: 40px;
  height: 40px;
  background: rgba(244, 63, 94, 0.1);
  color: var(--rose-500);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
}

.sa-modal-title {
  font-size: 1.125rem;
  font-weight: 700;
  margin: 0;
}

.sa-modal-subtitle {
  font-size: 0.75rem;
  color: var(--stone-500);
  margin: 0;
}

.sa-modal-body {
  flex: 1;
  display: grid;
  overflow: hidden;
}

@media (min-width: 768px) {
  .sa-modal-body {
    grid-template-columns: 1fr 1fr;
  }
}

.sa-modal-left {
  background: var(--stone-100);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  position: relative;
}

.sa-guide-canvas-wrapper {
  background: var(--white);
  padding: 1rem;
  border-radius: 50%;
  box-shadow: var(--shadow-xl);
}

.sa-guide-canvas {
  width: 280px;
  height: 280px;
}

.sa-guide-time {
  position: absolute;
  bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: rgba(255,255,255,0.8);
  backdrop-filter: blur(8px);
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--stone-600);
}

.sa-guide-time svg {
  color: var(--rose-500);
}

.sa-modal-right {
  padding: 2rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.sa-guide-connect {
  margin-bottom: 2rem;
  width: 100%;
}

.sa-guide-connect-label {
  font-size: 0.75rem;
  color: var(--stone-500);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.sa-guide-connect-pins {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
}

.sa-guide-from {
  opacity: 0.5;
  transform: scale(0.9);
}

.sa-guide-from p:first-child {
  font-size: 0.875rem;
  color: var(--stone-400);
}

.sa-guide-from p:last-child {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--stone-400);
}

.sa-guide-arrow {
  color: var(--rose-500);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.sa-guide-to p:first-child {
  font-size: 0.875rem;
  color: var(--rose-500);
  font-weight: 700;
}

.sa-guide-to p:last-child {
  font-size: 4.5rem;
  font-weight: 900;
  color: var(--stone-900);
  line-height: 1;
}

.sa-guide-progress {
  width: 100%;
  max-width: 280px;
  margin-bottom: 2rem;
}

.sa-guide-progress-header {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--stone-500);
  margin-bottom: 0.5rem;
}

.sa-guide-progress-bar {
  height: 16px;
  background: var(--stone-200);
  border-radius: 8px;
  overflow: hidden;
}

.sa-guide-progress-fill {
  height: 100%;
  background: var(--rose-500);
  border-radius: 8px;
  transition: width 0.3s ease;
}

.sa-guide-controls {
  display: flex;
  gap: 1rem;
  width: 100%;
  max-width: 320px;
}

.sa-guide-controls .sa-btn:first-child {
  flex: 1;
}

.sa-guide-controls .sa-btn:last-child {
  flex: 2;
}

/* Zoom controls */
.sa-zoom-controls {
  position: absolute;
  bottom: 0.5rem;
  right: 0.5rem;
  display: flex;
  gap: 0.5rem;
  z-index: 20;
}

.sa-zoom-btn {
  width: 32px;
  height: 32px;
  background: rgba(255,255,255,0.9);
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
  transition: background 0.2s;
}

.sa-zoom-btn:hover {
  background: var(--white);
}

.sa-zoom-btn svg {
  width: 16px;
  height: 16px;
  color: var(--stone-600);
}

/* Hidden when has image */
.sa-upload.has-image .sa-upload-placeholder {
  display: none;
}

/* Utility */
.hidden {
  display: none !important;
}
</style>

<div class="string-art-app" id="stringArtApp">
  <!-- LANDING PAGE -->
  <div class="sa-landing" id="saLanding">
    <!-- Navbar -->
    <nav class="sa-navbar">
      <div class="sa-container sa-navbar-inner">
        <a href="#" class="sa-logo">
          <div class="sa-logo-icon">#</div>
          <div class="sa-logo-text">String Art <span>2026</span></div>
        </a>
        <div class="sa-nav-links">
          <a href="#features">Caracter√≠sticas</a>
          <a href="#how-it-works">C√≥mo Funciona</a>
        </div>
        <button class="sa-btn sa-btn-outline" onclick="showApp()">Iniciar App</button>
      </div>
    </nav>

    <!-- Hero -->
    <section class="sa-hero">
      <div class="sa-container sa-hero-grid">
        <div class="sa-hero-content">
          <div class="sa-badge sa-badge-rose">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3zM5 19l1 3 1-3 3-1-3-1-1-3-1 3-3 1 3 1zM18 16l.7 2.1 2.1.7-2.1.7-.7 2.1-.7-2.1-2.1-.7 2.1-.7.7-2.1z"/></svg>
            Nueva Versi√≥n 2026
          </div>
          <h1 class="sa-hero-title">
            Convierte tus fotos en <span class="sa-text-gradient">Arte con Hilo</span>.
          </h1>
          <p class="sa-hero-desc">
            Nuestro algoritmo avanzado calcula la ruta perfecta de un solo hilo continuo para recrear cualquier imagen con precisi√≥n matem√°tica y belleza artesanal.
          </p>
          <div class="sa-hero-buttons">
            <button class="sa-btn sa-btn-accent sa-btn-lg" onclick="showApp()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><polygon points="10,8 16,12 10,16" fill="white"/></svg>
              COMENZAR A CREAR
            </button>
            <a href="#features" class="sa-btn sa-btn-outline sa-btn-lg">Ver c√≥mo funciona</a>
          </div>
        </div>

        <!-- Comparison Slider -->
        <div class="sa-comparison">
          <div class="sa-comparison-inner">
            <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=988&auto=format&fit=crop" alt="Original" class="sa-comparison-img">
            <div class="sa-comparison-label sa-comparison-label-left">FOTO ORIGINAL</div>
            
            <div class="sa-comparison-overlay" id="comparisonOverlay">
              <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=988&auto=format&fit=crop" alt="Result" class="sa-comparison-result">
              <div class="sa-comparison-texture"></div>
              <div class="sa-comparison-mask"></div>
              <div class="sa-comparison-label sa-comparison-label-right">RESULTADO HILO</div>
            </div>

            <div class="sa-comparison-handle" id="comparisonHandle">
              <div class="sa-comparison-handle-btn">
                <div class="sa-comparison-handle-line"></div>
                <div class="sa-comparison-handle-line"></div>
              </div>
            </div>

            <input type="range" min="0" max="100" value="50" class="sa-comparison-slider" id="comparisonSlider">

            <div class="sa-comparison-hint">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--rose-500)" stroke-width="2"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l3 3 3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg>
              <span>Desliza para comparar</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Features -->
    <section id="features" class="sa-features">
      <div class="sa-container">
        <div class="sa-section-header">
          <div class="sa-badge sa-badge-stone">Caracter√≠sticas</div>
          <h2 class="sa-section-title">Todo lo que necesitas para tu obra maestra</h2>
          <p class="sa-section-desc">Desde la carga de la imagen hasta el √∫ltimo clavo, hemos optimizado cada paso del proceso creativo.</p>
        </div>
        <div class="sa-features-grid">
          <div class="sa-feature-card">
            <div class="sa-feature-icon">‚ö°</div>
            <h3 class="sa-feature-title">Algoritmo Ultra R√°pido</h3>
            <p class="sa-feature-desc">Genera hasta 10,000 l√≠neas en segundos sin congelar tu navegador. Visualiza el proceso de tejido en tiempo real.</p>
          </div>
          <div class="sa-feature-card">
            <div class="sa-feature-icon">üé®</div>
            <h3 class="sa-feature-title">Editor Integrado</h3>
            <p class="sa-feature-desc">Ajusta brillo, contraste, zoom y posici√≥n de tu imagen para asegurar que el resultado final sea perfecto.</p>
          </div>
          <div class="sa-feature-card">
            <div class="sa-feature-icon">‚úÖ</div>
            <h3 class="sa-feature-title">Asistente de Construcci√≥n</h3>
            <p class="sa-feature-desc">Modo interactivo paso a paso que te gu√≠a clavo por clavo, guarda tu progreso y estima el tiempo restante.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section class="sa-cta">
      <div class="sa-container">
        <h2 class="sa-cta-title">¬øListo para tejer?</h2>
        <p class="sa-cta-desc">√önete a miles de creadores y convierte esa foto especial en un regalo inolvidable o una pieza de decoraci√≥n √∫nica.</p>
        <button class="sa-btn sa-btn-accent sa-btn-lg" onclick="showApp()">Crear Proyecto Nuevo</button>
      </div>
    </section>

    <!-- Footer -->
    <footer class="sa-footer">
      <p>¬© 2026 String Art Studio. Hecho con ‚ù§Ô∏è por Artistas.</p>
    </footer>
  </div>

  <!-- APP VIEW -->
  <div class="sa-app" id="saApp">
    <!-- App Header -->
    <header class="sa-app-header">
      <div class="sa-app-header-inner">
        <div class="sa-app-header-left">
          <button class="sa-btn sa-btn-ghost sa-btn-icon" onclick="showLanding()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          </button>
          <div class="sa-app-divider"></div>
          <div class="sa-app-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinning"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            <span>Editor</span>
          </div>
        </div>
        <div class="sa-app-status" id="statusMessage">Sube una imagen para comenzar</div>
      </div>
    </header>

    <!-- App Main -->
    <main class="sa-app-main">
      <!-- Control Panel -->
      <div class="sa-panel">
        <!-- Upload Section -->
        <div class="sa-panel-section">
          <div class="sa-panel-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            1. Imagen Fuente
          </div>
          <div class="sa-upload" id="uploadArea">
            <div class="sa-upload-placeholder">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              <span>Haz clic o arrastra imagen</span>
            </div>
            <input type="file" accept="image/*" class="sa-upload-input" id="fileInput">
            <canvas id="editorCanvas" width="500" height="500"></canvas>
            <div class="sa-zoom-controls hidden" id="zoomControls">
              <button class="sa-zoom-btn" onclick="zoomIn()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
              </button>
              <button class="sa-zoom-btn" onclick="zoomOut()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
              </button>
            </div>
          </div>
          <div class="sa-slider-group hidden" id="imageControls">
            <div class="sa-slider-item">
              <label class="sa-slider-label">Brillo</label>
              <input type="range" class="sa-slider" min="-50" max="50" value="0" id="brightnessSlider">
            </div>
            <div class="sa-slider-item">
              <label class="sa-slider-label">Contraste</label>
              <input type="range" class="sa-slider" min="-50" max="50" value="0" id="contrastSlider">
            </div>
          </div>
        </div>

        <hr class="sa-panel-divider">

        <!-- Configuration Section -->
        <div class="sa-panel-section">
          <div class="sa-panel-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>
            2. Configuraci√≥n
          </div>
          <div>
            <div class="sa-slider-header">
              <label>Cantidad de L√≠neas</label>
              <span id="linesValue">4,000</span>
            </div>
            <input type="range" class="sa-slider" min="1000" max="10000" step="500" value="4000" id="linesSlider">
          </div>
          <div class="sa-input-group" style="margin-top: 1rem;">
            <div class="sa-input-item">
              <label>Tama√±o (cm)</label>
              <input type="number" class="sa-input" value="50" id="sizeInput">
            </div>
            <div class="sa-input-item">
              <label>Pines (Clavos)</label>
              <input type="number" class="sa-input" value="288" id="pinsInput">
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="sa-actions">
          <button class="sa-btn sa-btn-primary" id="generateBtn" disabled onclick="startWeaving()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
            GENERAR ARTE
          </button>
          <button class="sa-btn sa-btn-accent hidden" id="guideBtn" onclick="showGuide()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><polygon points="10,8 16,12 10,16" fill="white"/></svg>
            INICIAR EN LIENZO
          </button>
          <button class="sa-btn sa-btn-outline hidden" id="downloadBtn" onclick="downloadInstructions()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Descargar TXT
          </button>
        </div>
      </div>

      <!-- Canvas Area -->
      <div>
        <div class="sa-canvas-area">
          <div class="sa-canvas-frame">
            <canvas id="displayCanvas" class="sa-canvas" width="600" height="600"></canvas>
            <div class="sa-canvas-placeholder" id="canvasPlaceholder">Vista previa del lienzo</div>
          </div>
          <div class="sa-progress hidden" id="progressContainer">
            <div class="sa-progress-bar">
              <div class="sa-progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
          </div>
          <div class="sa-stats">
            <div>
              <div class="sa-stat-value" id="linesCount">0</div>
              <div class="sa-stat-label">L√≠neas</div>
            </div>
            <div>
              <div class="sa-stat-value" id="diameterValue">50 cm</div>
              <div class="sa-stat-label">Di√°metro</div>
            </div>
            <div>
              <div class="sa-stat-value">Normal</div>
              <div class="sa-stat-label">Grosor</div>
            </div>
          </div>
        </div>

        <!-- History -->
        <div class="sa-history hidden" id="historySection">
          <div class="sa-history-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            Historial Reciente
          </div>
          <div class="sa-history-items" id="historyItems"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Guide Modal -->
  <div class="sa-modal" id="guideModal">
    <div class="sa-modal-content">
      <div class="sa-modal-header">
        <div class="sa-modal-header-left">
          <div class="sa-modal-icon">#</div>
          <div>
            <h2 class="sa-modal-title">Modo Constructor</h2>
            <p class="sa-modal-subtitle">Progreso guardado autom√°ticamente</p>
          </div>
        </div>
        <button class="sa-btn sa-btn-ghost sa-btn-icon" onclick="hideGuide()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="sa-modal-body">
        <div class="sa-modal-left">
          <div class="sa-guide-canvas-wrapper">
            <canvas id="guideCanvas" class="sa-guide-canvas" width="280" height="280"></canvas>
          </div>
          <div class="sa-guide-time">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <span>Restante: <span id="timeRemaining">0 min</span></span>
          </div>
        </div>
        <div class="sa-modal-right">
          <div class="sa-guide-connect">
            <div class="sa-guide-connect-label">Conectar</div>
            <div class="sa-guide-connect-pins">
              <div class="sa-guide-from">
                <p>Desde</p>
                <p id="fromPin">0</p>
              </div>
              <div class="sa-guide-arrow">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
              </div>
              <div class="sa-guide-to">
                <p>Hacia Pin</p>
                <p id="toPin">0</p>
              </div>
            </div>
          </div>
          <div class="sa-guide-progress">
            <div class="sa-guide-progress-header">
              <span>Inicio</span>
              <span id="stepCounter">Paso 1 de 0</span>
            </div>
            <div class="sa-guide-progress-bar">
              <div class="sa-guide-progress-fill" id="guideProgressFill" style="width: 0%"></div>
            </div>
          </div>
          <div class="sa-guide-controls">
            <button class="sa-btn sa-btn-outline" onclick="prevStep()" id="prevBtn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
              Anterior
            </button>
            <button class="sa-btn sa-btn-primary" onclick="nextStep()" id="nextBtn">
              SIGUIENTE
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // ===== STATE =====
  let imageSrc = null;
  let imageObject = null;
  let isProcessing = false;
  let stringSequence = [];
  let history = [];
  let guideStep = 0;
  let processingTimeout = null;
  let transform = { x: 0, y: 0, scale: 1 };

  // ===== CONSTANTS =====
  const CANVAS_SIZE = 600;
  const PROCESSING_SIZE = 500;
  const STRING_OPACITY = 0.5;
  const PHYSICAL_THREAD_THICKNESS_CM = 0.035;

  // ===== DOM ELEMENTS =====
  const elements = {
    landing: document.getElementById('saLanding'),
    app: document.getElementById('saApp'),
    uploadArea: document.getElementById('uploadArea'),
    fileInput: document.getElementById('fileInput'),
    editorCanvas: document.getElementById('editorCanvas'),
    displayCanvas: document.getElementById('displayCanvas'),
    guideCanvas: document.getElementById('guideCanvas'),
    guideModal: document.getElementById('guideModal'),
    statusMessage: document.getElementById('statusMessage'),
    generateBtn: document.getElementById('generateBtn'),
    guideBtn: document.getElementById('guideBtn'),
    downloadBtn: document.getElementById('downloadBtn'),
    imageControls: document.getElementById('imageControls'),
    zoomControls: document.getElementById('zoomControls'),
    brightnessSlider: document.getElementById('brightnessSlider'),
    contrastSlider: document.getElementById('contrastSlider'),
    linesSlider: document.getElementById('linesSlider'),
    linesValue: document.getElementById('linesValue'),
    sizeInput: document.getElementById('sizeInput'),
    pinsInput: document.getElementById('pinsInput'),
    progressContainer: document.getElementById('progressContainer'),
    progressFill: document.getElementById('progressFill'),
    canvasPlaceholder: document.getElementById('canvasPlaceholder'),
    linesCount: document.getElementById('linesCount'),
    diameterValue: document.getElementById('diameterValue'),
    historySection: document.getElementById('historySection'),
    historyItems: document.getElementById('historyItems'),
    comparisonSlider: document.getElementById('comparisonSlider'),
    comparisonOverlay: document.getElementById('comparisonOverlay'),
    comparisonHandle: document.getElementById('comparisonHandle'),
    fromPin: document.getElementById('fromPin'),
    toPin: document.getElementById('toPin'),
    stepCounter: document.getElementById('stepCounter'),
    guideProgressFill: document.getElementById('guideProgressFill'),
    timeRemaining: document.getElementById('timeRemaining'),
    prevBtn: document.getElementById('prevBtn'),
    nextBtn: document.getElementById('nextBtn')
  };

  // ===== NAVIGATION =====
  window.showApp = function() {
    elements.landing.classList.add('hidden');
    elements.app.classList.add('active');
  };

  window.showLanding = function() {
    elements.landing.classList.remove('hidden');
    elements.app.classList.remove('active');
  };

  // ===== COMPARISON SLIDER =====
  elements.comparisonSlider.addEventListener('input', function(e) {
    const value = e.target.value;
    elements.comparisonOverlay.style.clipPath = `inset(0 ${100 - value}% 0 0)`;
    elements.comparisonHandle.style.left = value + '%';
  });

  // ===== FILE UPLOAD =====
  elements.fileInput.addEventListener('change', function(e) {
    processFile(e.target.files[0]);
  });

  elements.uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    elements.uploadArea.classList.add('dragover');
  });

  elements.uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    elements.uploadArea.classList.remove('dragover');
  });

  elements.uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    elements.uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files[0]) {
      processFile(e.dataTransfer.files[0]);
    }
  });

  function processFile(file) {
    if (!file || !file.type.startsWith('image/')) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.src = event.target.result;
      img.onload = function() {
        imageObject = img;
        imageSrc = event.target.result;
        
        const scale = Math.max(PROCESSING_SIZE / img.width, PROCESSING_SIZE / img.height);
        const x = (PROCESSING_SIZE - img.width * scale) / 2;
        const y = (PROCESSING_SIZE - img.height * scale) / 2;
        transform = { x, y, scale };
        
        elements.uploadArea.classList.add('has-image');
        elements.imageControls.classList.remove('hidden');
        elements.zoomControls.classList.remove('hidden');
        elements.generateBtn.disabled = false;
        elements.canvasPlaceholder.classList.add('hidden');
        elements.statusMessage.textContent = 'Arrastra y haz zoom para ajustar';
        
        stringSequence = [];
        guideStep = 0;
        elements.guideBtn.classList.add('hidden');
        elements.downloadBtn.classList.add('hidden');
        
        drawEditorCanvas();
      };
    };
    reader.readAsDataURL(file);
  }

  // ===== CANVAS DRAWING =====
  function drawEditorCanvas() {
    if (!imageObject) return;
    
    const canvas = elements.editorCanvas;
    const ctx = canvas.getContext('2d');
    const brightness = parseInt(elements.brightnessSlider.value);
    const contrast = parseInt(elements.contrastSlider.value);
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.filter = `grayscale(100%) brightness(${100 + brightness}%) contrast(${100 + contrast}%)`;
    ctx.translate(transform.x, transform.y);
    ctx.scale(transform.scale, transform.scale);
    ctx.drawImage(imageObject, 0, 0);
    ctx.restore();
    
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.beginPath();
    ctx.rect(0, 0, PROCESSING_SIZE, PROCESSING_SIZE);
    ctx.arc(PROCESSING_SIZE / 2, PROCESSING_SIZE / 2, PROCESSING_SIZE / 2, 0, Math.PI * 2, true);
    ctx.fill();
    
    ctx.strokeStyle = '#f43f5e';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(PROCESSING_SIZE / 2, PROCESSING_SIZE / 2, (PROCESSING_SIZE / 2) - 2, 0, Math.PI * 2);
    ctx.stroke();
  }

  // ===== SLIDERS =====
  elements.brightnessSlider.addEventListener('input', drawEditorCanvas);
  elements.contrastSlider.addEventListener('input', drawEditorCanvas);

  elements.linesSlider.addEventListener('input', function(e) {
    elements.linesValue.textContent = parseInt(e.target.value).toLocaleString();
  });

  elements.sizeInput.addEventListener('input', function(e) {
    elements.diameterValue.textContent = e.target.value + ' cm';
  });

  // ===== ZOOM =====
  window.zoomIn = function() {
    transform.scale *= 1.1;
    drawEditorCanvas();
  };

  window.zoomOut = function() {
    transform.scale = Math.max(0.1, transform.scale * 0.9);
    drawEditorCanvas();
  };

  // ===== DRAG IMAGE =====
  let isDragging = false;
  let dragStart = { x: 0, y: 0 };

  elements.editorCanvas.addEventListener('mousedown', function(e) {
    if (!imageSrc) return;
    isDragging = true;
    dragStart = { x: e.clientX - transform.x, y: e.clientY - transform.y };
  });

  elements.editorCanvas.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    e.preventDefault();
    transform.x = e.clientX - dragStart.x;
    transform.y = e.clientY - dragStart.y;
    drawEditorCanvas();
  });

  elements.editorCanvas.addEventListener('mouseup', function() {
    isDragging = false;
  });

  elements.editorCanvas.addEventListener('mouseleave', function() {
    isDragging = false;
  });

  elements.editorCanvas.addEventListener('wheel', function(e) {
    if (!imageSrc) return;
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.05 : 0.05;
    transform.scale = Math.max(0.1, transform.scale + delta);
    drawEditorCanvas();
  });

  // ===== WEAVING ALGORITHM =====
  window.startWeaving = function() {
    if (!imageSrc) return;
    
    stopProcessing();
    isProcessing = true;
    elements.statusMessage.textContent = 'Calculando rutas de hilo...';
    elements.progressContainer.classList.remove('hidden');
    elements.progressFill.style.width = '0%';
    elements.generateBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg> DETENER';
    elements.generateBtn.onclick = stopProcessing;

    const numLines = parseInt(elements.linesSlider.value);
    const numPins = parseInt(elements.pinsInput.value);
    const diameterCm = parseInt(elements.sizeInput.value) || 50;

    const sourceCtx = elements.editorCanvas.getContext('2d');
    const imgData = sourceCtx.getImageData(0, 0, PROCESSING_SIZE, PROCESSING_SIZE);
    const pixels = imgData.data;
    const size = PROCESSING_SIZE;

    const pins = [];
    const center = size / 2;
    const radius = (size / 2) - 2;
    for (let i = 0; i < numPins; i++) {
      const angle = (2 * Math.PI * i) / numPins;
      pins.push({
        x: Math.round(center + radius * Math.cos(angle)),
        y: Math.round(center + radius * Math.sin(angle))
      });
    }

    const displayCanvas = elements.displayCanvas;
    displayCanvas.width = CANVAS_SIZE;
    displayCanvas.height = CANVAS_SIZE;
    const ctx = displayCanvas.getContext('2d');
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
    ctx.fillStyle = '#ddd';
    const displayScale = CANVAS_SIZE / size;
    pins.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x * displayScale, p.y * displayScale, 1.5, 0, Math.PI * 2);
      ctx.fill();
    });

    const physicalRatio = PHYSICAL_THREAD_THICKNESS_CM / diameterCm;
    const calculatedLineWidth = CANVAS_SIZE * physicalRatio;
    ctx.lineWidth = Math.max(0.15, calculatedLineWidth);
    ctx.strokeStyle = `rgba(0, 0, 0, ${STRING_OPACITY})`;

    let currentPin = 0;
    let sequence = [0];
    let lineCount = 0;
    const errorMatrix = new Int32Array(size * size);
    for (let i = 0; i < pixels.length; i += 4) {
      errorMatrix[i / 4] = 255 - pixels[i];
    }

    function step() {
      const linesPerFrame = 25;
      for (let batch = 0; batch < linesPerFrame; batch++) {
        if (lineCount >= numLines) {
          finishProcessing(sequence);
          return;
        }

        let bestPin = -1;
        let maxLineWeight = -1;
        const minDistance = 15;

        for (let nextPin = 0; nextPin < numPins; nextPin++) {
          const distance = Math.abs(nextPin - currentPin);
          if (distance < minDistance || distance > numPins - minDistance) continue;
          if (nextPin === currentPin) continue;

          const p1 = pins[currentPin];
          const p2 = pins[nextPin];
          let x0 = p1.x, y0 = p1.y, x1 = p2.x, y1 = p2.y;
          let dx = Math.abs(x1 - x0), dy = Math.abs(y1 - y0);
          let sx = (x0 < x1) ? 1 : -1, sy = (y0 < y1) ? 1 : -1;
          let err = dx - dy;
          let lineWeight = 0;
          let pixelCount = 0;

          while (true) {
            const idx = y0 * size + x0;
            if (idx >= 0 && idx < errorMatrix.length) {
              lineWeight += errorMatrix[idx];
              pixelCount++;
            }
            if (x0 === x1 && y0 === y1) break;
            let e2 = 2 * err;
            if (e2 > -dy) { err -= dy; x0 += sx; }
            if (e2 < dx) { err += dx; y0 += sy; }
          }

          const score = lineWeight / (pixelCount || 1);
          if (score > maxLineWeight) {
            maxLineWeight = score;
            bestPin = nextPin;
          }
        }

        if (bestPin !== -1) {
          const p1 = pins[currentPin];
          const p2 = pins[bestPin];
          let x0 = p1.x, y0 = p1.y, x1 = p2.x, y1 = p2.y;
          let dx = Math.abs(x1 - x0), dy = Math.abs(y1 - y0);
          let sx = (x0 < x1) ? 1 : -1, sy = (y0 < y1) ? 1 : -1;
          let err = dx - dy;
          const subtractionValue = 50;

          while (true) {
            const idx = y0 * size + x0;
            if (idx >= 0 && idx < errorMatrix.length) {
              errorMatrix[idx] = Math.max(0, errorMatrix[idx] - subtractionValue);
            }
            if (x0 === x1 && y0 === y1) break;
            let e2 = 2 * err;
            if (e2 > -dy) { err -= dy; x0 += sx; }
            if (e2 < dx) { err += dx; y0 += sy; }
          }

          ctx.beginPath();
          ctx.moveTo(p1.x * displayScale, p1.y * displayScale);
          ctx.lineTo(p2.x * displayScale, p2.y * displayScale);
          ctx.stroke();

          sequence.push(bestPin);
          currentPin = bestPin;
          lineCount++;
        } else {
          finishProcessing(sequence);
          return;
        }
      }

      const progress = Math.round((lineCount / numLines) * 100);
      elements.progressFill.style.width = progress + '%';
      elements.linesCount.textContent = sequence.length.toLocaleString();
      processingTimeout = setTimeout(step, 0);
    }

    step();
  };

  function stopProcessing() {
    if (processingTimeout) {
      clearTimeout(processingTimeout);
      processingTimeout = null;
    }
    isProcessing = false;
    elements.generateBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg> GENERAR ARTE';
    elements.generateBtn.onclick = startWeaving;
    elements.progressContainer.classList.add('hidden');
  }

  function finishProcessing(sequence) {
    stopProcessing();
    stringSequence = sequence;
    elements.statusMessage.textContent = '¬°Arte completado!';
    elements.guideBtn.classList.remove('hidden');
    elements.downloadBtn.classList.remove('hidden');
    elements.linesCount.textContent = sequence.length.toLocaleString();

    // Add to history
    const thumbnail = elements.displayCanvas.toDataURL('image/jpeg', 0.5);
    const historyItem = {
      id: Date.now(),
      thumbnail,
      config: {
        numLines: parseInt(elements.linesSlider.value),
        numPins: parseInt(elements.pinsInput.value),
        diameterCm: parseInt(elements.sizeInput.value),
        brightness: parseInt(elements.brightnessSlider.value),
        contrast: parseInt(elements.contrastSlider.value)
      },
      sequence: [...sequence],
      date: new Date().toLocaleTimeString()
    };
    history = [historyItem, ...history].slice(0, 6);
    renderHistory();
  }

  function renderHistory() {
    if (history.length === 0) {
      elements.historySection.classList.add('hidden');
      return;
    }
    elements.historySection.classList.remove('hidden');
    elements.historyItems.innerHTML = history.map((item, index) => `
      <div class="sa-history-item" onclick="restoreHistory(${index})">
        <div class="sa-history-thumb">
          <img src="${item.thumbnail}" alt="History">
        </div>
        <div class="sa-history-overlay">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
        </div>
        <div class="sa-history-meta">${item.config.numLines.toLocaleString()} L<br>${item.date}</div>
      </div>
    `).join('');
  }

  window.restoreHistory = function(index) {
    const item = history[index];
    if (!item) return;
    
    elements.linesSlider.value = item.config.numLines;
    elements.linesValue.textContent = item.config.numLines.toLocaleString();
    elements.pinsInput.value = item.config.numPins;
    elements.sizeInput.value = item.config.diameterCm;
    elements.diameterValue.textContent = item.config.diameterCm + ' cm';
    elements.brightnessSlider.value = item.config.brightness;
    elements.contrastSlider.value = item.config.contrast;
    stringSequence = item.sequence;
    elements.statusMessage.textContent = `Restaurado versi√≥n de ${item.date}`;
    elements.guideBtn.classList.remove('hidden');
    elements.downloadBtn.classList.remove('hidden');
    elements.linesCount.textContent = item.sequence.length.toLocaleString();
    
    // Redraw canvas
    const canvas = elements.displayCanvas;
    const ctx = canvas.getContext('2d');
    const img = new Image();
    img.src = item.thumbnail;
    img.onload = function() {
      ctx.drawImage(img, 0, 0, CANVAS_SIZE, CANVAS_SIZE);
    };
  };

  // ===== GUIDE =====
  window.showGuide = function() {
    if (stringSequence.length === 0) return;
    elements.guideModal.classList.add('active');
    guideStep = parseInt(localStorage.getItem('stringArtGuideStep') || '0');
    updateGuide();
  };

  window.hideGuide = function() {
    elements.guideModal.classList.remove('active');
  };

  window.nextStep = function() {
    if (guideStep < stringSequence.length - 2) {
      guideStep++;
      localStorage.setItem('stringArtGuideStep', guideStep);
      updateGuide();
    }
  };

  window.prevStep = function() {
    if (guideStep > 0) {
      guideStep--;
      localStorage.setItem('stringArtGuideStep', guideStep);
      updateGuide();
    }
  };

  function updateGuide() {
    const numPins = parseInt(elements.pinsInput.value);
    const currentPinIdx = stringSequence[guideStep];
    const nextPinIdx = stringSequence[guideStep + 1];

    elements.fromPin.textContent = currentPinIdx;
    elements.toPin.textContent = nextPinIdx;
    elements.stepCounter.textContent = `Paso ${guideStep + 1} de ${stringSequence.length - 1}`;
    
    const progress = ((guideStep + 1) / (stringSequence.length - 1)) * 100;
    elements.guideProgressFill.style.width = progress + '%';

    // Time remaining
    const remainingLines = Math.max(0, stringSequence.length - guideStep);
    const secondsPerLine = 7;
    const totalSeconds = remainingLines * secondsPerLine;
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    elements.timeRemaining.textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes} min`;

    // Update buttons
    elements.prevBtn.disabled = guideStep === 0;
    elements.nextBtn.disabled = guideStep >= stringSequence.length - 2;

    // Draw guide canvas
    const canvas = elements.guideCanvas;
    const ctx = canvas.getContext('2d');
    const size = 280;
    const center = size / 2;
    const radius = (size / 2) - 10;

    ctx.clearRect(0, 0, size, size);
    ctx.beginPath();
    ctx.arc(center, center, radius, 0, Math.PI * 2);
    ctx.strokeStyle = '#e7e5e4';
    ctx.lineWidth = 2;
    ctx.stroke();

    function getPinCoords(pinIdx) {
      const angle = (2 * Math.PI * pinIdx) / numPins;
      return {
        x: center + radius * Math.cos(angle),
        y: center + radius * Math.sin(angle)
      };
    }

    if (currentPinIdx !== undefined && nextPinIdx !== undefined) {
      const p1 = getPinCoords(currentPinIdx);
      const p2 = getPinCoords(nextPinIdx);

      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.strokeStyle = '#f43f5e';
      ctx.lineWidth = 3;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(p1.x, p1.y, 4, 0, Math.PI * 2);
      ctx.fillStyle = '#a8a29e';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(p2.x, p2.y, 6, 0, Math.PI * 2);
      ctx.fillStyle = '#f43f5e';
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  }

  // ===== DOWNLOAD =====
  window.downloadInstructions = function() {
    const numLines = elements.linesSlider.value;
    const numPins = elements.pinsInput.value;
    const diameterCm = elements.sizeInput.value;
    
    const content = `INSTRUCCIONES DE STRING ART 2026
===================================
Fecha: ${new Date().toLocaleDateString()}
Configuraci√≥n:
- L√≠neas: ${numLines}
- Pines: ${numPins}
- Di√°metro: ${diameterCm}cm

Secuencia de pines:
${stringSequence.join(' ‚Üí ')}`;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'string-art-instrucciones.txt';
    a.click();
    URL.revokeObjectURL(url);
  };

  // Initialize comparison slider position
  elements.comparisonOverlay.style.clipPath = 'inset(0 50% 0 0)';
  elements.comparisonHandle.style.left = '50%';
})();
</script>
